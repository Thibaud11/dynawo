# Copyright (c) 2015-2019, RTE (http://www.rte-france.com)
# See AUTHORS.txt
# All rights reserved.
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, you can obtain one at http://mozilla.org/MPL/2.0/.
# SPDX-License-Identifier: MPL-2.0
#
# This file is part of Dynawo, an hybrid C++/Modelica open source time domain simulation tool for power systems.

cmake_minimum_required(VERSION 3.9.6)

PROJECT(model CXX)

SET(DYNAWO_LIBRARY_TYPE "@LIBRARY_TYPE@")
SET(DYNAWO_MSVC_STATIC_RUNTIME_LIBRARY "@MSVC_STATIC_RUNTIME_LIBRARY@")

if(MSVC)
  if(DYNAWO_LIBRARY_TYPE STREQUAL "STATIC")
    if(DYNAWO_MSVC_STATIC_RUNTIME_LIBRARY)
      set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
    endif()
  endif()
endif()

SET(CMAKE_BUILD_TYPE "@CMAKE_BUILD_TYPE@" CACHE STRING "Choose the type of build, options are: Debug Release RelWithDebInfo MinSizeRel." FORCE)
SET(CMAKE_CXX_FLAGS "@CMAKE_CXX_FLAGS@")
SET(CMAKE_PREFIX_PATH "@CMAKE_PREFIX_PATH@")

IF(NOT MODEL_NAME OR "${MODEL_NAME}" STREQUAL "")
  MESSAGE(FATAL_ERROR "Need a model name to compile: please add -DMODEL_NAME=...")
ENDIF()

IF(MSVC)
  SET(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS ON)
  ADD_DEFINITIONS(-D_CRT_SECURE_NO_WARNINGS -D_SCL_SECURE_NO_WARNINGS)
  ADD_DEFINITIONS(-DLANG_CXX11)

  FIND_PACKAGE(dlfcn-win32 REQUIRED)
ENDIF()

#FIND_PACKAGE(XercesC 3.2.2 REQUIRED)

SET(LibXML_USE_STATIC_LIBS @LibXML_USE_STATIC_LIBS@)
FIND_PACKAGE(libXML 0.2.4 REQUIRED)

#FIND_PACKAGE(libIIDM 0.2.8 REQUIRED)

FIND_PACKAGE(Dynawo CONFIG REQUIRED PATHS $ENV{DYNAWO_INSTALL_DIR} PATH_SUFFIXES share)

SET(MODEL_SOURCES
  ${MODEL_NAME}.cpp
  ${MODEL_NAME}_Dyn.cpp
  ${MODEL_NAME}_Dyn_external.cpp
  )

IF(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/${MODEL_NAME}_Init.cpp)
  LIST(APPEND MODEL_SOURCES
    ${MODEL_NAME}_Init.cpp
    ${MODEL_NAME}_Init_external.cpp
    )
ENDIF()

ADD_LIBRARY(lib SHARED ${MODEL_SOURCES})
SET_TARGET_PROPERTIES(lib PROPERTIES OUTPUT_NAME ${MODEL_NAME} PREFIX "")

TARGET_INCLUDE_DIRECTORIES(lib PUBLIC $ENV{DYNAWO_ADDITIONAL_INCLUDE_FOR_PREASSEMBLED})

TARGET_LINK_LIBRARIES(lib
  Dynawo::dynawo_ModelManager
  $ENV{DYNAWO_ADDITIONAL_LIBRARY_FOR_PREASSEMBLED}
  )
